<?php

require_once $_SERVER['DOCUMENT_ROOT'] . '/config/main.php';

if (!isset($_SESSION["user"])) {
    header("HTTP/1.1 401 Unauthorized");
    exit("You must be logged in to access this api");
}

if (!isset($_POST["HeadColor"]) || !isset($_POST["TorsoColor"]) || !isset($_POST["LeftArmColor"]) || !isset($_POST["RightArmColor"]) || !isset($_POST["LeftLegColor"]) || !isset($_POST["RightLegColor"])) {
    header("HTTP/1.1 400 Bad Request");
    exit("Missing parameters");
}

$robloxBrickColors = array(
    '242,243,243' => 1,
    '161,165,162' => 2,
    '249,233,153' => 3,
    '215,197,154' => 5,
    '194,218,184' => 6,
    '232,186,200' => 9,
    '128,187,219' => 11,
    '203,132,66' => 12,
    '204,142,105' => 18,
    '196,40,28' => 21,
    '196,112,160' => 22,
    '13,105,172' => 23,
    '245,205,48' => 24,
    '98,71,50' => 25,
    '27,42,53' => 26,
    '109,110,108' => 27,
    '40,127,71' => 28,
    '161,196,140' => 29,
    '243,207,155' => 36,
    '75,151,75' => 37,
    '160,95,53' => 38,
    '193,202,222' => 39,
    '236,236,236' => 40,
    '205,84,75' => 41,
    '193,223,240' => 42,
    '123,182,232' => 43,
    '247,241,141' => 44,
    '180,210,228' => 45,
    '217,133,108' => 47,
    '132,182,141' => 48,
    '248,241,132' => 49,
    '236,232,222' => 50,
    '238,196,182' => 100,
    '218,134,122' => 101,
    '110,153,202' => 102,
    '199,193,183' => 103,
    '107,50,124' => 104,
    '226,155,64' => 105,
    '218,133,65' => 106,
    '0,143,156' => 107,
    '104,92,67' => 108,
    '67,84,147' => 110,
    '191,183,177' => 111,
    '104,116,172' => 112,
    '229,173,200' => 113,
    '199,210,60' => 115,
    '85,165,175' => 116,
    '183,215,213' => 118,
    '164,189,71' => 119,
    '217,228,167' => 120,
    '231,172,88' => 121,
    '211,111,76' => 123,
    '146,57,120' => 124,
    '234,184,146' => 125,
    '165,165,203' => 126,
    '220,188,129' => 127,
    '174,122,89' => 128,
    '156,163,168' => 131,
    '213,115,61' => 133,
    '216,221,86' => 134,
    '116,134,157' => 135,
    '135,124,144' => 136,
    '224,152,100' => 137,
    '149,138,115' => 138,
    '32,58,86' => 140,
    '39,70,45' => 141,
    '207,226,247' => 143,
    '121,136,161' => 145,
    '149,142,163' => 146,
    '147,135,103' => 147,
    '87,88,87' => 148,
    '22,29,50' => 149,
    '171,173,172' => 150,
    '120,144,130' => 151,
    '149,121,119' => 153,
    '123,46,47' => 154,
    '255,246,123' => 157,
    '225,164,194' => 158,
    '117,108,98' => 168,
    '151,105,91' => 176,
    '180,132,85' => 178,
    '137,135,136' => 179,
    '215,169,75' => 180,
    '249,214,46' => 190,
    '232,171,45' => 191,
    '105,64,40' => 192,
    '207,96,36' => 193,
    '163,162,165' => 194,
    '70,103,164' => 195,
    '35,71,139' => 196,
    '142,66,133' => 198,
    '99,95,98' => 199,
    '130,138,93' => 200,
    '229,228,223' => 208,
    '176,142,68' => 209,
    '112,149,120' => 210,
    '121,181,181' => 211,
    '159,195,233' => 212,
    '108,129,183' => 213,
    '144,76,42' => 216,
    '124,92,70' => 217,
    '150,112,159' => 218,
    '107,98,155' => 219,
    '167,169,206' => 220,
    '205,98,152' => 221,
    '228,173,200' => 222,
    '220,144,149' => 223,
    '240,213,160' => 224,
    '235,184,127' => 225,
    '253,234,141' => 226,
    '125,187,221' => 232,
    '52,43,117' => 268,
    '80,109,84' => 301,
    '91,93,105' => 302,
    '0,16,176' => 303,
    '44,101,29' => 304,
    '82,124,174' => 305,
    '51,88,130' => 306,
    '16,42,220' => 307,
    '61,21,133' => 308,
    '52,142,64' => 309,
    '91,154,76' => 310,
    '159,161,172' => 311,
    '89,34,89' => 312,
    '31,128,29' => 313,
    '159,173,192' => 314,
    '9,137,207' => 315,
    '123,0,123' => 316,
    '124,156,107' => 317,
    '138,171,133' => 318,
    '185,196,177' => 319,
    '202,203,209' => 320,
    '167,94,155' => 321,
    '123,47,123' => 322,
    '148,190,129' => 323,
    '168,189,153' => 324,
    '223,223,222' => 325,
    '151,0,0' => 327,
    '177,229,166' => 328,
    '152,194,219' => 329,
    '255,152,220' => 330,
    '255,89,89' => 331,
    '117,0,0' => 332,
    '239,184,56' => 333,
    '248,217,109' => 334,
    '231,231,236' => 335,
    '199,212,228' => 336,
    '255,148,148' => 337,
    '190,104,98' => 338,
    '86,36,36' => 339,
    '241,231,199' => 340,
    '254,243,187' => 341,
    '224,178,208' => 342,
    '212,144,189' => 343,
    '150,85,85' => 344,
    '143,76,42' => 345,
    '211,190,150' => 346,
    '226,220,188' => 347,
    '237,234,234' => 348,
    '233,218,218' => 349,
    '136,62,62' => 350,
    '188,155,93' => 351,
    '199,172,120' => 352,
    '202,191,163' => 353,
    '187,179,178' => 354,
    '108,88,75' => 355,
    '160,132,79' => 356,
    '149,137,136' => 357,
    '171,168,158' => 358,
    '175,148,131' => 359,
    '150,103,102' => 360,
    '86,66,54' => 361,
    '126,104,63' => 362,
    '105,102,92' => 363,
    '90,76,66' => 364,
    '106,57,9' => 365,
    '248,248,248' => 1001,
    '205,205,205' => 1002,
    '17,17,17' => 1003,
    '255,0,0' => 1004,
    '255,176,0' => 1005,
    '180,128,255' => 1006,
    '163,75,75' => 1007,
    '193,190,66' => 1008,
    '255,255,0' => 1009,
    '0,0,255' => 1010,
    '0,32,96' => 1011,
    '33,84,185' => 1012,
    '4,175,236' => 1013,
    '170,85,0' => 1014,
    '170,0,170' => 1015,
    '255,102,204' => 1016,
    '255,175,0' => 1017,
    '18,238,212' => 1018,
    '0,255,255' => 1019,
    '0,255,0' => 1020,
    '58,125,21' => 1021,
    '127,142,100' => 1022,
    '140,91,159' => 1023,
    '175,221,255' => 1024,
    '255,201,201' => 1025,
    '177,167,255' => 1026,
    '159,243,233' => 1027,
    '204,255,204' => 1028,
    '255,255,204' => 1029,
    '255,204,153' => 1030,
    '98,37,209' => 1031,
    '255,0,191' => 1032
);


function rgbToBrickColor($color) {
    global $robloxBrickColors;
    $color = str_replace("rgb(", "", $color);
    $color = str_replace(")", "", $color);
    $color = str_replace(" ", "", $color);
    $color = explode(",", $color);

    // Convert RGB values to integers
    $color = array_map('intval', $color);

    $colorKey = implode(",", $color); // Convert array to string
    return $robloxBrickColors[$colorKey] ?? 1; // Use the default value (ID 1) if the key is not found
}




$HeadColor = rgbToBrickColor($_POST["HeadColor"]);
$TorsoColor = rgbToBrickColor($_POST["TorsoColor"]);
$LeftArmColor = rgbToBrickColor($_POST["LeftArmColor"]);
$RightArmColor = rgbToBrickColor($_POST["RightArmColor"]);
$LeftLegColor = rgbToBrickColor($_POST["LeftLegColor"]);
$RightLegColor = rgbToBrickColor($_POST["RightLegColor"]);


$bodycolors = array(
    "HeadColor" => $HeadColor,
    "TorsoColor" => $TorsoColor,
    "LeftArmColor" => $LeftArmColor,
    "RightArmColor" => $RightArmColor,
    "LeftLegColor" => $LeftLegColor,
    "RightLegColor" => $RightLegColor
);



$userclass = new User;
$userclass->setBodyColors($_SESSION["user"]["id"], json_encode($bodycolors, JSON_PRETTY_PRINT));

Avatar::regenAvatar($_SESSION["user"]["id"]);

exit("Success");